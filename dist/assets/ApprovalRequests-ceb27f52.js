import{u as Q,j as t,a as s,F as G}from"./index-2b6d5067.js";import{r as l,u as K}from"./react-vendor-07fa9950.js";import{R as X}from"./RefreshButton-70383c8a.js";import{u as Y}from"./Confetti-c097a8ab.js";import{H as Z}from"./ContextualHelp-b538d0c7.js";function le(){const{showSuccess:v,showError:N,showWarning:g}=Q(),{celebrate:k,ConfettiContainer:P}=Y(),[n]=l.useState(()=>{try{const e=localStorage.getItem("auth");return e?JSON.parse(e):null}catch(e){return console.error("Failed to parse auth data:",e),null}}),[u,_]=l.useState([]),[j,w]=l.useState(!0),[h,C]=l.useState("all"),[d,A]=l.useState({open:!1,type:null,marksheet:null}),[R,q]=l.useState(!1),[i,c]=l.useState(""),[S,L]=l.useState(""),[f,I]=l.useState(!1),[M,O]=l.useState(!1),H=K();l.useEffect(()=>{(n==null?void 0:n.role)==="hod"?$():w(!1)},[n]);const $=async()=>{if(n){w(!0);try{const r=await(await fetch(`/api/marksheets?department=${n.department}&status=dispatch_requested,rescheduled_by_hod`)).json();r.success?_(r.marksheets):_([])}catch(e){console.error("Error fetching pending requests:",e),_([])}finally{w(!1)}}},J=async()=>{O(!0);try{await $()}finally{O(!1)}},F=(e,r)=>{c(""),A({open:!0,type:r,marksheet:e})},B=()=>{A({open:!1,type:null,marksheet:null}),c("")},U=async({comments:e,scheduledDispatchDate:r})=>{var a,x;if(!(!d.marksheet||!d.type))try{q(!0);const o=n._id||n.id,m=await fetch("/api/marksheets?action=hod-response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:d.marksheet._id,hodId:o,response:d.type,comments:e,scheduledDispatchDate:r})}),y=await m.json();if(!m.ok||!y.success)throw new Error(y.error||"Failed to submit response");const p=d.type==="approved"?"approved":d.type==="rejected"?"rejected":"rescheduled",D=((x=(a=d.marksheet)==null?void 0:a.studentDetails)==null?void 0:x.name)||"Student";L(`Dispatch request ${p} successfully.`),d.type==="approved"?v("âœ“ Approved",`Dispatch approved for ${D}`):d.type==="rejected"?g("Request Rejected",`Dispatch rejected for ${D}`):v("Rescheduled",`Dispatch rescheduled for ${D}`),B(),await $()}catch(o){c(o.message||"Unexpected error"),N("Action Failed",o.message||"Could not process the request")}finally{q(!1)}},E=async e=>{const r=b.filter(a=>a.status==="dispatch_requested"||a.status==="rescheduled_by_hod");if(r.length===0){L(`No pending requests available for bulk ${e}.`);return}try{I(!0),c("");const a=n._id||n.id,x=r.map(p=>fetch("/api/marksheets?action=hod-response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:p._id,hodId:a,response:e,comments:"",scheduledDispatchDate:null})}).then(D=>D.json())),o=await Promise.all(x),m=o.filter(p=>p.success).length,y=o.length-m;if(m>0){const p=`Successfully ${e} ${m} request${m>1?"s":""}.${y>0?` ${y} failed.`:""}`;L(p),v(`Bulk ${e.charAt(0).toUpperCase()+e.slice(1)}`,`${m}/${o.length} requests processed successfully`),y===0&&k()}else{const p=`Failed to ${e.slice(0,-1)} any requests. Please try again.`;c(p),N("Bulk Action Failed",p)}await $()}catch(a){c(a.message||`Failed to perform bulk ${e}`)}finally{I(!1)}},z=l.useMemo(()=>[{id:"all",label:"All",count:u.length},{id:"dispatch_requested",label:"Pending",count:u.filter(e=>e.status==="dispatch_requested").length},{id:"rescheduled_by_hod",label:"Rescheduled",count:u.filter(e=>e.status==="rescheduled_by_hod").length}],[u]),b=l.useMemo(()=>(h==="all"?u:u.filter(r=>r.status===h)).sort((r,a)=>{var m,y;const x=(((m=r.studentDetails)==null?void 0:m.regNumber)||"").toString().toLowerCase(),o=(((y=a.studentDetails)==null?void 0:y.regNumber)||"").toString().toLowerCase();return x.localeCompare(o,void 0,{numeric:!0,sensitivity:"base"})}),[u,h]),T={dispatch_requested:"bg-yellow-100 text-yellow-800",rescheduled_by_hod:"bg-orange-100 text-orange-800",approved_by_hod:"bg-green-100 text-green-800",rejected_by_hod:"bg-red-100 text-red-800",dispatched:"bg-purple-100 text-purple-800"},V={dispatch_requested:"â³",rescheduled_by_hod:"ðŸ”„",approved_by_hod:"âœ…",rejected_by_hod:"â›”",dispatched:"ðŸ“¤"},W=(e={})=>{const r=(e.year||"").toString(),a=(e.section||"").toString();return!r&&!a?"N/A":a?r?`${r}-${a}`:a:r};return!n||n.role!=="hod"?t("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:s("div",{className:"glass-card p-8 rounded-3xl text-center",children:[t("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),t("p",{className:"text-gray-600",children:"Only HODs can approve dispatch requests."})]})}):s("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:[t("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:s("div",{className:"max-w-6xl mx-auto",children:[s("div",{className:"text-center mb-8",children:[t("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Approval Requests"}),s("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["Review and approve dispatch requests for ",n.department," Department"]})]}),t("div",{className:"glass-card p-4 sm:p-6 md:p-8 rounded-2xl md:rounded-3xl mb-8",children:j?s("div",{className:"text-center py-12",children:[t("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),t("p",{className:"text-gray-600",children:"Loading pending requests..."})]}):u.length===0?s("div",{className:"text-center py-12",children:[t("svg",{className:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),t("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No pending requests"}),t("p",{className:"text-gray-600",children:"All dispatch requests have been processed"})]}):s(G,{children:[t("div",{className:"flex flex-wrap items-center gap-3 mb-6",children:z.map(e=>s("button",{onClick:()=>C(e.id),className:`px-4 py-2 rounded-full text-sm font-medium border transition-all duration-200 ${h===e.id?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:border-blue-400"}`,children:[e.label,t("span",{className:`ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-semibold ${h===e.id?"bg-white/25 text-white":"bg-gray-100 text-gray-700"}`,children:e.count})]},e.id))}),S&&t("div",{className:"mb-6 rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800",children:S}),i&&t("div",{className:"mb-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800",children:i}),s("div",{className:"mb-6 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100",children:[s("div",{className:"flex items-start justify-between gap-4 mb-3",children:[t("div",{className:"flex items-center gap-2",children:s("div",{children:[s("div",{className:"flex items-center gap-2",children:[t("h3",{className:"text-sm font-semibold text-gray-900",children:"Bulk Actions"}),t(Z,{content:"Quickly approve, reschedule, or reject all pending dispatch requests at once."})]}),s("p",{className:"text-xs text-gray-600",children:[b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length," pending requests available"]})]})}),t(X,{isLoading:M,onClick:J})]}),s("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3",children:[t("button",{onClick:()=>E("approved"),disabled:f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0,className:`px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1 ${f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0?"bg-gray-300 cursor-not-allowed":"bg-green-600 hover:bg-green-700"}`,children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"âœ…"}),t("span",{children:f?"Processing...":"Approve All"})]})}),t("button",{onClick:()=>E("rescheduled"),disabled:f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0,className:`px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-1 ${f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0?"bg-gray-300 cursor-not-allowed":"bg-orange-500 hover:bg-orange-600"}`,children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"ðŸ”„"}),t("span",{children:f?"Processing...":"Reschedule All"})]})}),t("button",{onClick:()=>E("rejected"),disabled:f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0,className:`px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 ${f||b.filter(e=>e.status==="dispatch_requested"||e.status==="rescheduled_by_hod").length===0?"bg-gray-300 cursor-not-allowed":"bg-red-600 hover:bg-red-700"}`,children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"â›”"}),t("span",{children:f?"Processing...":"Reject All"})]})})]})]}),t("div",{className:"space-y-4",children:b.map(e=>{var r,a,x,o;return s("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[s("div",{className:"p-4 sm:p-6 pb-3 sm:pb-4",children:[s("div",{className:"flex items-start justify-between mb-3 gap-2",children:[s("div",{className:"flex-1 min-w-0",children:[t("h3",{className:"text-lg sm:text-xl font-bold text-gray-900 mb-1 truncate",children:(r=e.studentDetails)==null?void 0:r.name}),s("p",{className:"text-xs sm:text-sm text-gray-600",children:[(a=e.studentDetails)==null?void 0:a.regNumber," â€¢ ",W(e.studentDetails)]})]}),s("span",{className:`px-2 py-1 sm:px-3 sm:py-1.5 rounded-full text-xs font-semibold uppercase tracking-wide flex items-center gap-1 whitespace-nowrap ${T[e.status]||"bg-yellow-100 text-yellow-800"}`,children:[t("span",{className:"text-xs sm:text-sm",children:V[e.status]||"ðŸ“„"}),t("span",{className:"text-xs",children:(e.status||"").replace(/_/g," ")})]})]}),s("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6 text-xs sm:text-sm",children:[s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Staff:"}),t("p",{className:"font-medium text-gray-900 truncate",children:e.staffName||"demo staff"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Parent Phone:"}),t("p",{className:"font-medium text-gray-900",children:((x=e.studentDetails)==null?void 0:x.parentPhoneNumber)||"â€”"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Exam Date:"}),t("p",{className:"font-medium text-gray-900",children:e.examinationDate?new Date(e.examinationDate).toLocaleDateString("en-US",{month:"short",year:"numeric"}):"â€”"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Subjects:"}),t("p",{className:"font-medium text-gray-900",children:((o=e.subjects)==null?void 0:o.length)||0})]})]})]}),t("div",{className:"border-t border-gray-100"}),t("div",{className:"p-4 sm:p-6 pt-3 sm:pt-4 bg-gray-50",children:s("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3",children:[s("button",{onClick:()=>F(e,"approved"),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-green-600 hover:bg-green-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1",children:[t("span",{className:"hidden sm:inline",children:"Approve Dispatch"}),t("span",{className:"sm:hidden",children:"Approve"})]}),s("button",{onClick:()=>F(e,"rejected"),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-red-600 hover:bg-red-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1",children:[t("span",{className:"hidden sm:inline",children:"Reject Request"}),t("span",{className:"sm:hidden",children:"Reject"})]}),t("button",{onClick:()=>F(e,"rescheduled"),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs sm:text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-1",children:"Reschedule"}),s("button",{onClick:()=>H(`/marksheets/${e._id||e.marksheetId}`),className:"px-3 sm:px-4 py-2 sm:py-2.5 bg-white hover:bg-gray-50 text-gray-700 text-xs sm:text-sm font-medium rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1",children:[t("span",{className:"hidden sm:inline",children:"View Details"}),t("span",{className:"sm:hidden",children:"Details"})]})]})}),t("div",{className:"my-6 border-t border-dashed border-gray-300"})]},e._id)})})]})})]})}),t(ee,{open:d.open,type:d.type,marksheet:d.marksheet,onClose:B,onSubmit:U,loading:R,error:i}),t(P,{})]})}function ee({open:v,type:N,marksheet:g,onClose:k,onSubmit:P,loading:n,error:u}){var R,q;const[_,j]=l.useState(""),[w,h]=l.useState("");if(l.useEffect(()=>{var i;if(!(!v||!g))if(j(""),(i=g.dispatchRequest)!=null&&i.scheduledDispatchDate){const c=new Date(g.dispatchRequest.scheduledDispatchDate);Number.isNaN(c.getTime())?h(""):h(c.toISOString().slice(0,16))}else h("")},[v,N,g]),!v||!g)return null;const C=N==="rescheduled",d=N==="approved"?"Approve dispatch request":N==="rejected"?"Reject dispatch request":"Reschedule dispatch request",A=i=>{i.preventDefault();const c={comments:_.trim()||void 0,scheduledDispatchDate:void 0};if(w){const S=new Date(w);Number.isNaN(S.getTime())||(c.scheduledDispatchDate=S.toISOString())}P(c)};return t("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4",children:s("div",{className:"glass-card w-full max-w-lg p-6",children:[s("div",{className:"mb-4",children:[t("h3",{className:"text-xl font-semibold text-gray-900",children:d}),s("p",{className:"text-sm text-gray-600 mt-1",children:[(R=g.studentDetails)==null?void 0:R.name," â€¢ ",(q=g.studentDetails)==null?void 0:q.regNumber]})]}),s("form",{onSubmit:A,className:"space-y-4",children:[s("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Comments (optional)"}),t("textarea",{value:_,onChange:i=>j(i.target.value),rows:4,className:"w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:outline-none",placeholder:N==="rejected"?"Let the staff know the reason for rejection":"Add any notes for the staff member"})]}),s("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Schedule (optional)"}),t("input",{type:"datetime-local",value:w,onChange:i=>h(i.target.value),required:C,className:"w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:outline-none"}),C&&t("p",{className:"text-xs text-gray-500 mt-2",children:"Provide the new date/time for dispatch. This will be visible to the staff member."})]}),u&&t("div",{className:"rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:u}),s("div",{className:"flex justify-end gap-3 pt-2",children:[t("button",{type:"button",onClick:k,className:"px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-100",children:"Cancel"}),t("button",{type:"submit",disabled:n,className:`px-5 py-2 rounded-lg text-white ${n?"bg-blue-300 cursor-wait":"bg-blue-600 hover:bg-blue-700"}`,children:n?"Saving...":"Confirm"})]})]})]})})}export{le as default};
