import{j as e,a as t,F as w}from"./index-2b6d5067.js";import{f as A,u as U,r as i}from"./react-vendor-07fa9950.js";function G(){var S,j,k,C,_,R,I,q,E,M,O,P;const{id:l}=A(),x=U(),[a,h]=i.useState(null),[N,g]=i.useState(!0),[b,f]=i.useState(""),[o,p]=i.useState(!1),[c,n]=i.useState({studentDetails:{},subjects:[]}),[u]=i.useState(()=>{try{const r=localStorage.getItem("auth");return r?JSON.parse(r):null}catch{return null}});i.useEffect(()=>{(async()=>{if(!l||l==="undefined"||l==="null"){f("Invalid marksheet id"),g(!1);return}try{const s=await fetch(`/api/marksheets?marksheetId=${encodeURIComponent(l)}`),d=await s.json();!s.ok||!d.success||!d.marksheet?f(d.error||"Failed to load marksheet"):(h(d.marksheet),d.marksheet&&n({studentDetails:{...d.marksheet.studentDetails||{}},subjects:Array.isArray(d.marksheet.subjects)?[...d.marksheet.subjects]:[]}))}catch(s){f(s.message||"Unexpected error")}finally{g(!1)}})()},[l]);const v=i.useMemo(()=>{const r=(a==null?void 0:a.status)||"unknown",s={draft:{label:"Draft",className:"bg-gray-100 text-gray-800"},verified_by_staff:{label:"Verified by Staff",className:"bg-green-100 text-green-800"},dispatch_requested:{label:"Dispatch Requested",className:"bg-yellow-100 text-yellow-800"},rescheduled_by_hod:{label:"Rescheduled by HOD",className:"bg-orange-100 text-orange-800"},approved_by_hod:{label:"Approved by HOD",className:"bg-blue-100 text-blue-800"},rejected_by_hod:{label:"Rejected by HOD",className:"bg-red-100 text-red-800"},dispatched:{label:"Dispatched",className:"bg-purple-100 text-purple-800"},unknown:{label:"Unknown",className:"bg-gray-200 text-gray-700"}};return s[r]||s.unknown},[a]),V=i.useMemo(()=>{var d;if(!a||!u||u.role!=="staff")return!1;const r=((d=a.staffId)==null?void 0:d._id)||a.staffId,s=u._id||u.id;if(!r||!s)return!1;try{return String(r)===String(s)}catch{return!1}},[a,u]),D=(u==null?void 0:u.role)==="staff"&&V;return N?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e("p",{className:"text-gray-600",children:"Loading marksheet..."})]})}):b||!a?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Not Found"}),e("p",{className:"text-gray-600",children:b||"Marksheet not found"}),e("button",{onClick:()=>x(-1),className:"mt-6 px-5 py-2 bg-blue-600 text-white rounded-lg",children:"Go Back"})]})}):e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:e("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:t("div",{className:"max-w-4xl mx-auto",children:[t("div",{className:"text-center mb-12",children:[e("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Marksheet Details"}),t("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["View, verify, and manage individual student marksheet details.",e("br",{}),"Check grades, dispatch status, and update student information as needed."]})]}),t("div",{className:"glass-card p-8 rounded-3xl transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[t("div",{className:"flex items-center justify-between mb-6",children:[e("h2",{className:"text-3xl font-bold text-gray-900",children:(S=a.studentDetails)==null?void 0:S.name}),e("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${v.className}`,children:v.label.toUpperCase()})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Student"}),o?t("div",{className:"space-y-3",children:[t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Name"}),e("input",{value:c.studentDetails.name||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,name:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Reg No"}),e("input",{value:c.studentDetails.regNumber||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,regNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{className:"grid grid-cols-2 gap-3",children:[t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Year"}),e("input",{value:c.studentDetails.year||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,year:r.target.value}})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., II"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Semester"}),e("input",{value:c.semester||c.studentDetails.semester||"",onChange:r=>n(s=>({...s,semester:r.target.value})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., 1"})]})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Department"}),e("input",{value:c.studentDetails.department||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,department:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),t("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Parent Phone"}),e("input",{value:c.studentDetails.parentPhoneNumber||"",onChange:r=>n(s=>({...s,studentDetails:{...s.studentDetails,parentPhoneNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]})]}):t(w,{children:[t("p",{className:"text-gray-700",children:[e("strong",{children:"Reg No:"})," ",(j=a.studentDetails)==null?void 0:j.regNumber]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Year/Sem:"})," ",(k=a.studentDetails)==null?void 0:k.year,"/",a.semester||((C=a.studentDetails)==null?void 0:C.semester)||"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Department:"})," ",(_=a.studentDetails)==null?void 0:_.department]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Parent:"})," ",(R=a.studentDetails)==null?void 0:R.parentPhoneNumber]})]})]}),t("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Summary"}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Name:"})," ",a.examinationName||"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Date:"})," ",a.examinationDate?new Date(a.examinationDate).toLocaleString("default",{month:"long",year:"numeric"}):"N/A"]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Overall Grade:"})," ",a.overallGrade]}),t("p",{className:"text-gray-700",children:[e("strong",{children:"Staff:"})," ",a.staffName]}),a.hodName&&t("p",{className:"text-gray-700",children:[e("strong",{children:"HOD:"})," ",a.hodName]}),a.status==="approved_by_hod"&&((I=a.dispatchRequest)==null?void 0:I.respondedAt)&&t("p",{className:"text-gray-700",children:[e("strong",{children:"Approved On:"})," ",new Date(a.dispatchRequest.respondedAt).toLocaleString()]})]})]}),(((q=a.dispatchRequest)==null?void 0:q.hodResponse)||((E=a.dispatchRequest)==null?void 0:E.scheduledDispatchDate))&&t("div",{className:"mt-6 bg-white p-6 rounded-xl border border-gray-200",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Dispatch Notes"}),t("dl",{className:"space-y-2 text-gray-700",children:[((M=a.dispatchRequest)==null?void 0:M.hodResponse)&&t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"HOD Decision"}),e("dd",{className:"capitalize",children:a.dispatchRequest.hodResponse})]}),((O=a.dispatchRequest)==null?void 0:O.hodComments)&&t("div",{children:[e("dt",{className:"font-medium",children:"Comments"}),e("dd",{className:"text-gray-700 mt-1",children:a.dispatchRequest.hodComments})]}),((P=a.dispatchRequest)==null?void 0:P.scheduledDispatchDate)&&t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"Scheduled Dispatch"}),e("dd",{children:new Date(a.dispatchRequest.scheduledDispatchDate).toLocaleString()})]})]})]}),t("div",{className:"mt-8 bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Subjects"}),o?e("div",{className:"space-y-3",children:c.subjects.map((r,s)=>t("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e("input",{value:r.subjectName,onChange:d=>n(y=>{const m=[...y.subjects];return m[s]={...m[s],subjectName:d.target.value},{...y,subjects:m}}),className:"border rounded-lg px-3 py-2"}),e("input",{type:"number",value:r.marks,onChange:d=>n(y=>{const m=[...y.subjects];return m[s]={...m[s],marks:Number(d.target.value)},{...y,subjects:m}}),className:"border rounded-lg px-3 py-2"}),e("input",{value:r.grade,onChange:d=>n(y=>{const m=[...y.subjects];return m[s]={...m[s],grade:d.target.value},{...y,subjects:m}}),className:"border rounded-lg px-3 py-2"})]},s))}):e("div",{className:"divide-y divide-gray-100",children:(a.subjects||[]).map((r,s)=>t("div",{className:"py-3 space-y-1 sm:space-y-0 sm:grid sm:grid-cols-2 sm:items-center",children:[e("span",{className:"text-gray-800 break-words min-w-0",children:r.subjectName}),t("div",{className:"flex items-center justify-between sm:justify-end gap-2 text-gray-700",children:[e("span",{className:"font-semibold",children:r.marks}),t("span",{className:"whitespace-nowrap",children:["Grade: ",r.grade]})]})]},s))})]}),t("div",{className:"mt-8 flex flex-col sm:flex-row gap-3",children:[e("button",{onClick:()=>x(-1),className:"px-5 py-2 bg-gray-100 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Back"}),!o&&D&&t(w,{children:[e(F,{marksheet:a,onVerified:h}),e("button",{onClick:()=>p(!0),className:"px-5 py-2 bg-blue-600 text-white rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Edit & Regenerate"})]}),o&&D&&t(w,{children:[e("button",{onClick:()=>p(!1),className:"px-5 py-2 bg-gray-200 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Cancel"}),e(L,{id:a._id,form:c,onSaved:r=>{h(r),p(!1)}})]})]})]})]})})})}function F({marksheet:l,onVerified:x}){const[a,h]=i.useState(!1),[N,g]=i.useState(""),[b,f]=i.useState(!1),[o]=i.useState(()=>{try{const n=localStorage.getItem("auth");return n?JSON.parse(n):null}catch{return null}});i.useEffect(()=>{(l==null?void 0:l.status)==="verified_by_staff"||(l==null?void 0:l.status)==="approved_by_hod"||(l==null?void 0:l.status)==="dispatched"?f(!0):f(!1)},[l]);const p=["approved_by_hod","rejected_by_hod","dispatched","rescheduled_by_hod"],c=async()=>{if(!(o!=null&&o.eSignature)){g("Please upload your signature in Settings before verifying marksheets");return}h(!0),g("");try{const n=o.eSignature,u=await fetch("/api/marksheets?action=verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:l._id,staffSignature:n})}),v=await u.json();!u.ok||!v.success?g(v.error||"Verification failed"):(f(!0),x(v.marksheet))}catch(n){g(n.message||"Unexpected error")}finally{h(!1)}};return t(w,{children:[e("button",{disabled:a||b||p.includes(l==null?void 0:l.status),onClick:c,className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${b||p.includes(l==null?void 0:l.status)?"bg-green-200 text-green-900 cursor-not-allowed":a?"bg-green-200 text-green-900":"bg-green-600 text-white"}`,children:b?"Verified":a?"Verifying...":"Verify"}),N&&e("span",{className:"text-red-600 text-sm ml-2",children:N})]})}function L({id:l,form:x,onSaved:a}){const[h,N]=i.useState(!1),[g,b]=i.useState("");return t(w,{children:[e("button",{disabled:h,onClick:async()=>{N(!0),b("");try{const o=await fetch("/api/marksheets",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:l,studentDetails:x.studentDetails,subjects:x.subjects})}),p=await o.json();!o.ok||!p.success?b(p.error||"Save failed"):a(p.marksheet)}catch(o){b(o.message||"Unexpected error")}finally{N(!1)}},className:`px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ${h?"bg-blue-200 text-blue-900":"bg-blue-600 text-white"}`,children:h?"Saving...":"Save Changes"}),g&&e("span",{className:"text-red-600 text-sm ml-2",children:g})]})}export{G as default};
