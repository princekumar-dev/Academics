import{j as t,a,F as S}from"./index-2b6d5067.js";import{r as c}from"./react-vendor-07fa9950.js";import{R as z}from"./RefreshButton-70383c8a.js";function X(){const[i]=c.useState(()=>{const e=localStorage.getItem("auth");return e?JSON.parse(e):null}),[r,h]=c.useState([]),[k,x]=c.useState(!0),[y,R]=c.useState(!1),[m,$]=c.useState([]),[w,A]=c.useState(null),[_,C]=c.useState(!1),[b,P]=c.useState("all"),[v,f]=c.useState(""),[N,p]=c.useState(""),[F,j]=c.useState(!1);c.useEffect(()=>{(i==null?void 0:i.role)==="staff"?g():x(!1)},[i]);const g=async()=>{if(i){x(!0);try{const e=(i==null?void 0:i._id)||(i==null?void 0:i.id)||localStorage.getItem("userId"),n=await(await fetch(`/api/marksheets?staffId=${e}&status=verified_by_staff,dispatch_requested,rescheduled_by_hod,approved_by_hod,rejected_by_hod,dispatched`)).json();n.success?h(n.marksheets):h([])}catch(e){console.error("Error fetching marksheets:",e),h([])}finally{x(!1)}}},L=async()=>{j(!0);try{await g()}finally{j(!1)}},I=async e=>{try{return await(await fetch("/api/marksheets?action=request-dispatch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:e,staffId:i._id||i.id})})).json()}catch(s){return{success:!1,error:s.message}}},D=async e=>{f(""),p(""),$(s=>Array.from(new Set([...s,e])));try{const s=await I(e);s!=null&&s.success?(f("Dispatch request submitted for HOD approval."),h(n=>n.map(o=>o._id===e?{...o,status:"dispatch_requested",dispatchRequest:{...o.dispatchRequest||{},requestedAt:new Date().toISOString(),requestedBy:(i==null?void 0:i._id)||(i==null?void 0:i.id),hodResponse:null,hodComments:null,scheduledDispatchDate:null}}:o))):p((s==null?void 0:s.error)||"Failed to request dispatch")}catch(s){console.error(s),p("Unexpected error while requesting dispatch")}finally{$(s=>s.filter(n=>n!==e)),g()}},E=async()=>{const e=r.filter(s=>s.status==="verified_by_staff");if(e.length!==0){f(""),p(""),R(!0);try{const s=[];for(const l of e){const d=await I(l._id);s.push(d)}const n=s.filter(l=>l==null?void 0:l.success).length,o=s.length-n;n>0&&f(`Submitted ${n} dispatch request${n>1?"s":""} for approval.`),o>0&&p(`Failed to submit ${o} request${o>1?"s":""}. Please try again.`)}finally{R(!1),g()}}},M=async e=>{if(e!=null&&e._id){f(""),p(""),A(e._id);try{const n=`${typeof window<"u"?window.location.origin:""}/api/generate-pdf?marksheetId=${e._id}`,o=await fetch("/api/whatsapp-dispatch?action=send-marksheet",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:e._id,marksheetPdfUrl:n})}),l=await o.json();if(!o.ok||!l.success){const d=l.details||l.error||"Failed to dispatch marksheet";throw d.includes("Authenticate")||d.includes("authentication")?new Error("Twilio authentication failed. Please verify TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN in .env file. See TWILIO_SETUP_GUIDE.md"):l.setupGuide?new Error(`${d}. ${l.setupGuide}`):new Error(d)}f("Marksheet dispatched to parent via WhatsApp."),h(d=>d.map(u=>u._id===e._id?{...u,status:"dispatched"}:u)),await g()}catch(s){console.error(s),p(s.message||"Unable to dispatch marksheet.")}finally{A(null)}}},U=async()=>{const e=r.filter(s=>s.status==="approved_by_hod");if(e.length!==0){f(""),p(""),C(!0);try{const s=typeof window<"u"?window.location.origin:"",n=[];for(const d of e)try{const u=`${s}/api/generate-pdf?marksheetId=${d._id}`,O=await fetch("/api/whatsapp-dispatch?action=send-marksheet",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marksheetId:d._id,marksheetPdfUrl:u})}),T=await O.json();O.ok&&T.success?(n.push({success:!0,id:d._id}),h(G=>G.map(q=>q._id===d._id?{...q,status:"dispatched"}:q))):n.push({success:!1,id:d._id,error:T.error})}catch(u){n.push({success:!1,id:d._id,error:u.message})}const o=n.filter(d=>d.success).length,l=n.length-o;o>0&&f(`Successfully sent ${o} marksheet${o>1?"s":""} via WhatsApp.`),l>0&&p(`Failed to send ${l} marksheet${l>1?"s":""}. Please try sending them individually.`)}catch(s){console.error(s),p("Unexpected error while sending marksheets via WhatsApp.")}finally{C(!1),await g()}}},W=c.useMemo(()=>[{id:"all",label:"All",count:r.length},{id:"verified_by_staff",label:"Ready",count:r.filter(e=>e.status==="verified_by_staff").length},{id:"dispatch_requested",label:"Pending",count:r.filter(e=>e.status==="dispatch_requested").length},{id:"rescheduled_by_hod",label:"Rescheduled",count:r.filter(e=>e.status==="rescheduled_by_hod").length},{id:"approved_by_hod",label:"Approved",count:r.filter(e=>e.status==="approved_by_hod").length},{id:"rejected_by_hod",label:"Rejected",count:r.filter(e=>e.status==="rejected_by_hod").length},{id:"dispatched",label:"Dispatched",count:r.filter(e=>e.status==="dispatched").length}],[r]),B=c.useMemo(()=>(b==="all"?r:r.filter(s=>s.status===b)).sort((s,n)=>{var d,u;const o=(((d=s.studentDetails)==null?void 0:d.regNumber)||"").toString().toLowerCase(),l=(((u=n.studentDetails)==null?void 0:u.regNumber)||"").toString().toLowerCase();return o.localeCompare(l,void 0,{numeric:!0,sensitivity:"base"})}),[r,b]),H={verified_by_staff:"bg-blue-100 text-blue-800",dispatch_requested:"bg-yellow-100 text-yellow-800",rescheduled_by_hod:"bg-orange-100 text-orange-800",approved_by_hod:"bg-green-100 text-green-800",rejected_by_hod:"bg-red-100 text-red-800",dispatched:"bg-purple-100 text-purple-800"},J={verified_by_staff:"ðŸ“‹",dispatch_requested:"â³",rescheduled_by_hod:"ðŸ”„",approved_by_hod:"âœ…",rejected_by_hod:"â›”",dispatched:"ðŸ“¤"};return!i||i.role!=="staff"?t("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:a("div",{className:"glass-card p-8 rounded-3xl text-center",children:[t("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),t("p",{className:"text-gray-600",children:"Only staff members can manage dispatch requests."})]})}):t("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:t("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:a("div",{className:"max-w-6xl mx-auto",children:[a("div",{className:"text-center mb-8",children:[t("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Dispatch Requests"}),a("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["Submit and track WhatsApp dispatch requests for verified marksheets.",t("br",{}),"Request approval, send reports, and manage dispatch status for your students."]})]}),t("div",{className:"glass-card p-8 rounded-3xl mb-8",children:k?a("div",{className:"text-center py-12",children:[t("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),t("p",{className:"text-gray-600",children:"Loading verified marksheets..."})]}):r.length===0?a("div",{className:"text-center py-12",children:[t("svg",{className:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),t("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No marksheets available"}),t("p",{className:"text-gray-600",children:"Import and verify marksheets to begin requesting dispatch approvals."})]}):a(S,{children:[a("div",{className:"bg-blue-50 p-4 rounded-xl mb-6 text-blue-800",children:[t("strong",{children:"Tip:"})," Request dispatch after verifying marksheets. Once the HOD approves, you can send the report directly to parents via WhatsApp."]}),t("div",{className:"flex flex-wrap items-center gap-2 mb-6",children:W.map(e=>a("button",{onClick:()=>P(e.id),className:`px-3 py-2 rounded-full text-xs sm:text-sm font-medium border transition-colors duration-200 whitespace-nowrap ${b===e.id?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:border-yellow-400"}`,children:[e.label,t("span",{className:`ml-1 inline-flex items-center justify-center px-1.5 py-0.5 rounded-full text-xs font-semibold ${b===e.id?"bg-white/25 text-white":"bg-gray-100 text-gray-700"}`,children:e.count})]},e.id))}),(v||N)&&a("div",{className:"mb-6 space-y-2",children:[v&&t("div",{className:"rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800",children:v}),N&&t("div",{className:"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:N})]}),a("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 mb-6",children:[a("div",{className:"flex items-center gap-2 sm:gap-4 flex-wrap",children:[t("button",{onClick:E,disabled:y||r.every(e=>e.status!=="verified_by_staff"),className:`inline-flex items-center gap-2 px-4 sm:px-6 py-2 rounded-lg font-semibold whitespace-nowrap ${y||r.every(e=>e.status!=="verified_by_staff")?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"}`,children:y?"Requesting...":"ðŸ“‹ Request All"}),t("button",{onClick:U,disabled:_||r.every(e=>e.status!=="approved_by_hod"),className:`inline-flex items-center gap-2 px-4 sm:px-6 py-2 rounded-lg font-semibold whitespace-nowrap ${_||r.every(e=>e.status!=="approved_by_hod")?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 transition-colors"}`,children:_?a(S,{children:[t("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Sending..."]}):t(S,{children:"ðŸ“¤ Send All"})})]}),t("div",{className:"self-end sm:self-auto",children:t(z,{isLoading:F,onClick:L})})]}),t("div",{className:"space-y-4",children:B.map(e=>{var s,n,o,l,d,u;return t("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-yellow-300",children:a("div",{className:"p-4 sm:p-6 pb-3 sm:pb-4",children:[a("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-4",children:[a("div",{className:"flex-1 min-w-0",children:[t("h3",{className:"text-lg sm:text-xl font-bold text-gray-900 mb-1 break-words",children:(s=e.studentDetails)==null?void 0:s.name}),a("p",{className:"text-xs sm:text-sm text-gray-600",children:[(n=e.studentDetails)==null?void 0:n.regNumber," â€¢ ",K(e.studentDetails)]})]}),a("span",{className:`px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs font-semibold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 flex-shrink-0 whitespace-nowrap ${H[e.status]||"bg-gray-100 text-gray-700"}`,children:[t("span",{className:"text-xs sm:text-sm",children:J[e.status]||"ðŸ“„"}),t("span",{className:"text-xs",children:(e.status||"").replace(/_/g," ")})]})]}),a("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4",children:[a("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 sm:gap-6 text-xs sm:text-sm flex-1",children:[a("div",{children:[t("p",{className:"text-gray-500 mb-1 font-medium",children:"Parent:"}),t("p",{className:"font-medium text-gray-900 truncate",children:((o=e.studentDetails)==null?void 0:o.parentPhoneNumber)||"â€”"})]}),a("div",{children:[t("p",{className:"text-gray-500 mb-1 font-medium",children:"Requested:"}),t("p",{className:"font-medium text-gray-900",children:(l=e.dispatchRequest)!=null&&l.requestedAt?new Date(e.dispatchRequest.requestedAt).toLocaleDateString():"â€”"})]}),a("div",{children:[t("p",{className:"text-gray-500 mb-1 font-medium",children:"HOD Decision:"}),t("p",{className:"font-medium text-gray-900",children:(d=e.dispatchRequest)!=null&&d.hodResponse?e.dispatchRequest.hodResponse.toUpperCase():"â€”"})]})]}),a("div",{className:"w-full md:w-auto md:flex-shrink-0",children:[e.status==="verified_by_staff"&&t("button",{onClick:()=>D(e._id),disabled:m.includes(e._id),className:`w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-1 ${m.includes(e._id)?"bg-blue-300 cursor-wait":"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}`,children:m.includes(e._id)?"Requestingâ€¦":"Request Dispatch"}),e.status==="rescheduled_by_hod"&&t("button",{onClick:()=>D(e._id),disabled:m.includes(e._id),className:`w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-1 ${m.includes(e._id)?"bg-orange-300 cursor-wait":"bg-orange-500 hover:bg-orange-600 focus:ring-orange-500"}`,children:m.includes(e._id)?"Submittingâ€¦":"Request Again"}),e.status==="approved_by_hod"&&t("button",{onClick:()=>M(e),disabled:w===e._id,className:`w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-1 ${w===e._id?"bg-green-300 cursor-wait":"bg-green-600 hover:bg-green-700 focus:ring-green-500"}`,children:w===e._id?"Sendingâ€¦":"Send via WhatsApp"}),e.status==="rejected_by_hod"&&t("a",{href:`/marksheets/${e._id}`,className:"block w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-red-600 border border-red-200 bg-white hover:bg-red-50 text-center text-xs sm:text-sm transition-colors duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1",children:"Review Marksheet"}),e.status==="dispatched"&&t("a",{href:`/api/generate-pdf?marksheetId=${e._id}`,target:"_blank",rel:"noreferrer",className:"block w-full md:px-6 px-3 sm:px-4 py-2 rounded-lg font-medium text-yellow-600 border border-yellow-300 bg-white hover:bg-yellow-50 hover:border-yellow-400 text-center text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-1",children:"Download PDF"})]})]}),((u=e.dispatchRequest)==null?void 0:u.hodComments)&&a("div",{className:"mt-4 bg-gray-50 border border-dashed border-gray-200 rounded-lg p-3",children:[t("p",{className:"text-xs text-gray-500 mb-1 font-medium",children:"HOD Comments:"}),t("p",{className:"text-gray-700 text-xs sm:text-sm",children:e.dispatchRequest.hodComments})]})]})},e._id)})})]})})]})})})}function K(i={}){const r=(i.year||"").toString(),h=(i.section||"").toString();return!r&&!h?"â€”":h?r?r.includes("-")?r:`${r}-${h}`:h:r}export{X as default};
